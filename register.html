<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>New Subscriber Registration - SMARTLINKX</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="site-header">
    <div class="container header-row">
      <div class="brand">
        <div class="logo">S</div>
        <div>
          <div class="brand-name">SMARTLINKX</div>
          <div class="brand-tag">New Subscriber Registration</div>
        </div>
      </div>

      <nav class="nav">
        <a href="index.html">Home</a>
        <a href="register.html" class="active">New Subscriber</a>
        <a href="masterfile.html">Masterfile</a>
        <a href="billing.html">Billing</a>
        <a href="payments.html">Payments</a>
      </nav>
    </div>
  </header>

  <main class="section">
    <div class="container">
      <h1>New Subscriber Registration</h1>
      <p class="muted">Subscriber ID is generated automatically to avoid duplicates.</p>

      <div class="card">
        <form id="registrationForm" class="form-grid">

          <div class="field">
            <label>Date</label>
            <input type="date" name="date" id="date" required />
          </div>

          <div class="field">
            <label>Subscriber ID</label>
            <input type="text" name="subscriberId" id="subscriberId" readonly />
            <small class="muted">Auto-generated</small>
          </div>

          <div class="field">
            <label>Plan</label>
            <select name="plan" id="planSelect" required></select>
          </div>

          <div class="field">
            <label>Name</label>
            <input type="text" name="name" placeholder="Subscriber full name" required />
          </div>

          <div class="field">
            <label>Contact No.</label>
            <input type="text" name="contactNo" placeholder="09xx..." required />
          </div>

          <div class="field full">
            <label>Address</label>
            <input type="text" name="address" placeholder="Complete address" required />
          </div>

          <div class="field">
            <label>Installation Fee (₱)</label>
            <input type="number" name="installationFee" id="installationFee" required />
          </div>

          <div class="field">
            <label>Monthly Payment (₱)</label>
            <input type="number" name="monthlyPayment" id="monthlyPayment" required />
          </div>

          <div class="field">
            <label>MAC Address</label>
            <input type="text" name="macAddress" placeholder="Optional" />
          </div>

          <div class="field">
            <label>IP Address</label>
            <input type="text" name="ipAddress" placeholder="Optional" />
          </div>

          <div class="field full">
            <button class="btn primary" type="submit" id="submitBtn">
              Submit Registration
            </button>
          </div>

          <div class="field full">
            <div class="alert" id="statusBox" style="display:none;"></div>
          </div>
        </form>
      </div>

      <div class="card info">
        <h3>Default Pricing</h3>
        <ul class="clean">
          <li>Installation Fee: <b>₱2,000</b></li>
          <li>Plans: <b>20Mbps ₱699</b>, <b>100Mbps ₱1299</b></li>
        </ul>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <div>© <span id="year"></span> SMARTLINKX</div>
    </div>
  </footer>

  <script src="app.js"></script>

  <script>
    // ===============================
    // CONFIG (set these once)
    // ===============================
 <script>
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbz-WpBesdbod91BgncMD68J7jZekbMB9aOwO7Yb_Mn2SoiOD-tLO-6rAiNl_suFKFKSkw/exec";
  const ADMIN_KEY = "SMARTLINKX_ISP_04082025";

  function todayISO(){
    return new Date().toISOString().slice(0,10);
  }

  function setStatus(el, msg, type){
    el.style.display = "block";
    el.className = "alert " + (type || "");
    el.textContent = msg;
  }

  const dateInput = document.getElementById("date");
  const idInput = document.getElementById("subscriberId");
  const statusBox = document.getElementById("statusBox");

  dateInput.value = todayISO();
  document.getElementById("year").textContent = new Date().getFullYear();

  async function loadNextSubscriberId(){
    try {
      const url = `${GAS_API_URL}?action=nextid&key=${encodeURIComponent(ADMIN_KEY)}`;
      console.log("Calling:", url);

      const res = await fetch(url);
      const json = await res.json();

      if (json.ok && json.nextId) {
        idInput.value = json.nextId;
      } else {
        setStatus(statusBox, "Failed to generate Subscriber ID", "bad");
      }
    } catch (e) {
      console.error(e);
      setStatus(statusBox, "Connection error", "bad");
    }
  }

  loadNextSubscriberId();
</script>



    // Plans (must match your backend expectations)
    const PLANS = [
      { name: "20Mbps", monthly: 699 },
      { name: "100Mbps", monthly: 1299 }
    ];
    const DEFAULT_INSTALL_FEE = 2000;

    // ===============================
    // Helpers
    // ===============================
    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function setStatus(el, msg, type){
      el.style.display = "block";
      el.className = "alert " + (type || "");
      el.textContent = msg;
    }

    // ===============================
    // Init UI
    // ===============================
    const form = document.getElementById("registrationForm");
    const dateInput = document.getElementById("date");
    const idInput = document.getElementById("subscriberId");
    const planSelect = document.getElementById("planSelect");
    const installInput = document.getElementById("installationFee");
    const monthlyInput = document.getElementById("monthlyPayment");
    const statusBox = document.getElementById("statusBox");
    const submitBtn = document.getElementById("submitBtn");

    dateInput.value = todayISO();
    installInput.value = DEFAULT_INSTALL_FEE;

    document.getElementById("year").textContent = new Date().getFullYear();

    // Fill plan dropdown
    planSelect.innerHTML = `<option value="" disabled selected>Select a plan</option>` +
      PLANS.map(p => `<option value="${p.name}" data-monthly="${p.monthly}">${p.name} - ₱${p.monthly}/mo</option>`).join("");

    function syncMonthly(){
      const opt = planSelect.options[planSelect.selectedIndex];
      const m = Number(opt?.getAttribute("data-monthly") || 0);
      monthlyInput.value = m || "";
    }
    planSelect.addEventListener("change", syncMonthly);

    // ===============================
    // Auto-generate Subscriber ID
    // ===============================
   async function loadNextSubscriberId(){
  try {
    const api = (typeof API_URL !== "undefined")
      ? API_URL
      : "https://script.google.com/macros/s/AKfycbz-WpBesdbod91BgncMD68J7jZekbMB9aOwO7Yb_Mn2SoiOD-tLO-6rAiNl_suFKFKSkw/exec";
    

    const adminKey = "SMARTLINKX_ISP_04082025";

    const url = `${api}?action=nextid&key=${encodeURIComponent(adminKey)}`;
    console.log("NEXTID URL:", url);

    const res = await fetch(url);
    const json = await res.json();

    if (json.ok && json.nextId) {
      idInput.value = json.nextId;
    } else {
      setStatus(statusBox, "Failed to generate Subscriber ID: " + (json.error || "Unknown"), "bad");
    }
  } catch (err) {
    console.error(err);
    setStatus(statusBox, "Error loading Subscriber ID.", "bad");
  }
}


    // ===============================
    // Submit registration
    // ===============================
    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();

      // Basic client-side validation
      if (!idInput.value) {
        setStatus(statusBox, "Subscriber ID not generated yet. Refresh the page.", "bad");
        return;
      }
      if (!planSelect.value) {
        setStatus(statusBox, "Please select a plan.", "bad");
        return;
      }
      if (!monthlyInput.value) {
        setStatus(statusBox, "Monthly payment missing. Select a plan again.", "bad");
        return;
      }

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());

      // Add required key for Apps Script
      payload.key = ADMIN_KEY;

      // Ensure numeric values
      payload.installationFee = Number(payload.installationFee || DEFAULT_INSTALL_FEE);
      payload.monthlyPayment = Number(payload.monthlyPayment || 0);

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting...";

      try {
        const res = await fetch(GAS_API_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const json = await res.json().catch(() => ({}));

        if (!res.ok || !json.ok) {
          throw new Error(json.error || `Request failed (${res.status})`);
        }

        setStatus(statusBox, "Saved! Subscriber registered successfully.", "ok");
        form.reset();

        // Reset defaults
        dateInput.value = todayISO();
        installInput.value = DEFAULT_INSTALL_FEE;
        planSelect.selectedIndex = 0;
        monthlyInput.value = "";

        // Generate next ID again
        await loadNextSubscriberId();

      } catch (err) {
        setStatus(statusBox, "Failed: " + err.message, "bad");
      } finally {
        submitBtn.textContent = "Submit Registration";
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
